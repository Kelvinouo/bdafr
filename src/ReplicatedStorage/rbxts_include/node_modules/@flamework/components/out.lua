-- Decompiled with the Synapse X Luau decompiler.

local v1 = _G[script];
local v2 = v1.import(script, v1.getModule(script, "@rbxts", "services"));
local v3 = v1.import(script, v1.getModule(script, "@flamework", "core").out);
local l__Modding__4 = v3.Modding;
local v5 = l__Modding__4.createMetaDecorator("Class");
local v6 = setmetatable({}, {
	__tostring = function()
		return "BaseComponent";
	end
});
v6.__index = v6;
function v6.new(...)
	local v7 = setmetatable({}, v6);
	return v7:constructor(...) and v7;
end;
local u1 = v1.import(script, v1.getModule(script, "@rbxts", "maid").Maid);
function v6.constructor(p1)
	p1.maid = u1.new();
	p1._attributeChangeHandlers = {};
end;
function v6.setInstance(p2, p3, p4)
	p2.instance = p3;
	p2.attributes = p4;
end;
function v6.setAttribute(p5, p6, p7, p8)
	p5.attributes[p6] = p7;
	p5.instance:SetAttribute(p6, p7);
	if p8 then
		return p5.attributes[p6];
	end;
	return p7;
end;
function v6.onAttributeChanged(p9, p10, p11)
	local v8 = p9._attributeChangeHandlers[p10];
	if not v8 then
		v8 = {};
		p9._attributeChangeHandlers[p10] = v8;
	end;
	table.insert(v8, p11);
end;
function v6.destroy(p12)
	p12.maid:Destroy();
end;
local v9 = setmetatable({}, {
	__tostring = function()
		return "Components";
	end
});
v9.__index = v9;
function v9.new(...)
	local v10 = setmetatable({}, v9);
	return v10:constructor(...) and v10;
end;
function v9.constructor(p13)
	p13.components = {};
	p13.classParentCache = {};
	p13.activeComponents = {};
	p13.activeInheritedComponents = {};
	p13.reverseComponentsMapping = {};
end;
local l__Reflect__2 = v3.Reflect;
function v9.onInit(p14)
	local v11 = {};
	for v12, v13 in ipairs((l__Modding__4.getDecorators("$c:init@Component"))) do
		local l__object__14 = v13.object;
		v11[l__object__14] = {
			ctor = l__object__14, 
			config = v13.arguments[1] or {}, 
			identifier = l__Reflect__2.getMetadata(l__object__14, "identifier")
		};
	end;
	p14.components = v11;
end;
local l__RunService__3 = v2.RunService;
local l__CollectionService__4 = v2.CollectionService;
function v9.onStart(p15)
	for v15, v16 in pairs(p15.components) do
		local l__config__17 = v16.config;
		local l__ctor__18 = v16.ctor;
		local l__identifier__19 = v16.identifier;
		if l__config__17.tag ~= nil then
			local u5 = p15:getInstanceGuard(l__ctor__18);
			local u6 = {};
			local u7 = nil;
			local u8 = {};
			u7 = function(p16)
				local u9 = nil;
				u9 = p16.DescendantRemoving:Connect(function()
					l__RunService__3.Heartbeat:Wait();
					if not u5(p16) then
						p15:removeComponent(p16, l__ctor__18);
						u9:Disconnect();
						u8[p16] = nil;
						local u10 = nil;
						u10 = p16.DescendantAdded:Connect(function()
							if u5(p16) then
								p15:addComponent(p16, l__ctor__18, true);
								u10:Disconnect();
								u6[p16] = nil;
								u7(p16);
							end;
						end);
						u6[p16] = u10;
					end;
				end);
				u8[p16] = u9;
			end;
			local function v20(p17)
				if l__RunService__3:IsServer() or not u5 then
					return p15:addComponent(p17, l__ctor__18);
				end;
				if u5(p17) then
					p15:addComponent(p17, l__ctor__18, true);
					u7(p17);
					return;
				end;
				local u11 = nil;
				u11 = p17.DescendantAdded:Connect(function()
					if u5(p17) then
						p15:addComponent(p17, l__ctor__18, true);
						u11:Disconnect();
						u6[p17] = nil;
						u7(p17);
					end;
				end);
				u6[p17] = u11;
			end;
			l__CollectionService__4:GetInstanceAddedSignal(l__config__17.tag):Connect(v20);
			l__CollectionService__4:GetInstanceRemovedSignal(l__config__17.tag):Connect(function(p18)
				u6[p18] = nil;
				u8[p18] = nil;
				local v21 = u6[p18];
				if v21 ~= nil then
					v21:Disconnect();
				end;
				local v22 = u8[p18];
				if v22 ~= nil then
					v22:Disconnect();
				end;
				p15:removeComponent(p18, l__ctor__18);
			end);
			for v23, v24 in ipairs(l__CollectionService__4:GetTagged(l__config__17.tag)) do
				p15:safeCall("Failed to instantiate '" .. l__identifier__19 .. "' for " .. tostring(v24), function()
					return v20(v24);
				end);
			end;
		end;
	end;
end;
function v9.getParentConstructor(p19, p20)
	local v25 = getmetatable(p20);
	if not v25 or type(v25) ~= "table" then
		return;
	end;
	return rawget(v25, "__index");
end;
function v9.getOrderedParents(p21, p22, p23)
	if p23 == nil then
		p23 = true;
	end;
	local v26 = p21.classParentCache[p22];
	if v26 then
		return v26;
	end;
	local v27 = { p22 };
	local v28 = p22;
	while true do
		v28 = p21:getParentConstructor(v28);
		if v28 == nil then
			break;
		end;
		if not p23 or v28 ~= v6 then
			table.insert(v27, v28);
		end;	
	end;
	p21.classParentCache[p22] = v27;
	return v27;
end;
function v9.getAttributeGuards(p24, p25)
	local v29 = {};
	local v30 = p24.components[p25];
	if v30 then
		if v30.config.attributes ~= nil then
			for v31, v32 in pairs(v30.config.attributes) do
				v29[v31] = v32;
			end;
		end;
		local v33 = getmetatable(p25);
		if v33.__index ~= nil then
			for v34, v35 in pairs(p24:getAttributeGuards(v33.__index)) do
				if v29[v34] == nil then
					v29[v34] = v35;
				end;
			end;
		end;
	end;
	return v29;
end;
function v9.getAttributes(p26, p27, p28, p29)
	local v36 = p27:GetAttributes();
	local v37 = {};
	local l__defaults__38 = p28.config.defaults;
	for v39, v40 in pairs(p29) do
		local v41 = v36[v39];
		if not v40(v41) then
			local v42 = l__defaults__38;
			if v42 ~= nil then
				v42 = v42[v39];
			end;
			if v42 ~= nil then
				v37[v39] = l__defaults__38[v39];
				p27:SetAttribute(v39, l__defaults__38[v39]);
			else
				error(p27:GetFullName() .. " has invalid attribute '" .. v39 .. "' for '" .. p28.identifier .. "'");
			end;
		else
			v37[v39] = v41;
		end;
	end;
	return v37;
end;
function v9.getInstanceGuard(p30, p31)
	local v43 = nil;
	local v44 = p30.components[p31];
	if v44 then
		if v44.config.instanceGuard ~= nil then
			return v44.config.instanceGuard;
		end;
		v43 = getmetatable(p31);
		if v43.__index == nil then
			return;
		end;
	else
		return;
	end;
	return p30:getInstanceGuard(v43.__index);
end;
function v9.safeCall(p32, p33, p34)
	task.spawn(function()
		xpcall(p34, function(p35)
			if type(p35) == "string" then
				local v45 = debug.traceback(p35, 2);
				warn(p33);
				warn(v45);
				return;
			end;
			warn(p33);
			warn(p35);
			warn(debug.traceback(nil, 2));
		end);
	end);
end;
local l__Flamework__12 = v3.Flamework;
function v9.setupComponent(p36, p37, p38, p39, p40, p41)
	local l__config__46 = p41.config;
	local l__identifier__47 = p41.identifier;
	p39:setInstance(p37, p38);
	p40();
	if l__Flamework__12._implements(p39, "$:flamework@OnStart") then
		p36:safeCall("Component '" .. l__identifier__47 .. "' failed to start " .. p37:GetFullName(), function()
			return p39:onStart();
		end);
	end;
	l__Modding__4.addListener(p39);
	p39.maid:GiveTask(function()
		return l__Modding__4.removeListener(p39);
	end);
	if l__config__46.refreshAttributes == nil or l__config__46.refreshAttributes then
		local v48 = table.clone(p38);
		for v49, v50 in pairs((p36:getAttributeGuards(p41.ctor))) do
			if type(v49) == "string" then
				p39.maid:GiveTask(p37:GetAttributeChangedSignal(v49):Connect(function()
					local v51 = p39._attributeChangeHandlers[v49];
					local v52 = p37:GetAttribute(v49);
					if v50(v52) then
						if v51 then
							for v53, v54 in ipairs(v51) do
								p36:safeCall("Component '" .. l__identifier__47 .. "' failed to call onAttributeChanged for " .. v49, function()
									return v54(v52, v48[v49]);
								end);
							end;
						end;
						p39.attributes[v49] = v52;
						v48[v49] = v52;
					end;
				end));
			end;
		end;
	end;
end;
function v9.getComponentFromSpecifier(p42, p43)
	if type(p43) ~= "string" then
		return p43;
	end;
	return l__Reflect__2.idToObj[p43];
end;
function v9.getIdFromSpecifier(p44, p45)
	if p45 == nil then
		return;
	end;
	if type(p45) == "string" then
		return p45;
	end;
	return l__Reflect__2.getMetadata(p45, "identifier");
end;
function v9.addIdMapping(p46, p47, p48, p49)
	local v55 = p49[p48];
	if not v55 then
		v55 = {};
		p49[p48] = v55;
	end;
	local v56 = p46.reverseComponentsMapping[p48];
	if not v56 then
		v56 = {};
		p46.reverseComponentsMapping[p48] = v56;
	end;
	v55[p47] = true;
	v56[p47] = true;
end;
function v9.removeIdMapping(p50, p51, p52, p53)
	local v57 = p50.activeInheritedComponents[p51];
	if not v57 then
		return nil;
	end;
	local v58 = v57[p53];
	if not v58 then
		return nil;
	end;
	local v59 = p50.reverseComponentsMapping[p53];
	if not v59 then
		return nil;
	end;
	v58[p52] = nil;
	v59[p52] = nil;
	local v60 = 0;
	for v61 in pairs(v59) do
		v60 = v60 + 1;
	end;
	if v60 == 0 then
		p50.reverseComponentsMapping[p53] = nil;
	end;
	local v62 = 0;
	for v63 in pairs(v58) do
		v62 = v62 + 1;
	end;
	if v62 == 0 then
		v57[p53] = nil;
	end;
	local v64 = 0;
	for v65 in pairs(v57) do
		v64 = v64 + 1;
	end;
	if v64 == 0 then
		p50.activeInheritedComponents[p51] = nil;
	end;
end;
function v9.getComponent(p54, p55, p56)
	local v66 = p54:getComponentFromSpecifier(p56);
	assert(v66, "Could not find component from specifier: " .. tostring(p56));
	local v67 = p54.activeComponents[p55];
	if not v67 then
		return nil;
	end;
	return v67[v66];
end;
function v9.getComponents(p57, p58, p59)
	local v68 = p57:getIdFromSpecifier(p59);
	if v68 == nil then
		return {};
	end;
	local v69 = p57.activeInheritedComponents[p58];
	if not v69 then
		return {};
	end;
	local v70 = v69[v68];
	if not v70 then
		return {};
	end;
	local v71 = {};
	local v72 = #v71;
	for v73 in pairs(v70) do
		v72 = v72 + 1;
		v71[v72] = v73;
	end;
	return v71;
end;
function v9.addComponent(p60, p61, p62, p63)
	local v74 = p60:getComponentFromSpecifier(p62);
	assert(v74, "Could not find component from specifier: " .. tostring(p62));
	local v75 = p60.components[v74];
	assert(v75, "Provided componentSpecifier does not exist");
	if p63 ~= true then
		local v76 = p60:getInstanceGuard(v74);
		if v76 ~= nil then
			assert(v76(p61), p61:GetFullName() .. " did not pass instance guard check for '" .. v75.identifier .. "'");
		end;
	end;
	local v77 = p60.activeComponents[p61];
	if not v77 then
		v77 = {};
		p60.activeComponents[p61] = v77;
	end;
	local v78 = p60.activeInheritedComponents[p61];
	if not v78 then
		v78 = {};
		p60.activeInheritedComponents[p61] = v78;
	end;
	local v79 = v77[v74];
	if v79 ~= nil then
		return v79;
	end;
	local v80 = l__Modding__4.createDeferredDependency(v74);
	local v81 = v80[1];
	v77[v74] = v81;
	for v82, v83 in ipairs(p60:getOrderedParents(v74)) do
		local v84 = l__Reflect__2.getOwnMetadata(v83, "identifier");
		if v84 ~= nil then
			p60:addIdMapping(v81, v84, v78);
		end;
	end;
	for v85, v86 in ipairs((l__Reflect__2.getMetadatas(v74, "flamework:implements"))) do
		for v87, v88 in ipairs(v86) do
			p60:addIdMapping(v81, v88, v78);
		end;
	end;
	p60:setupComponent(p61, p60:getAttributes(p61, v75, (p60:getAttributeGuards(v74))), v81, v80[2], v75);
	return v81;
end;
function v9.removeComponent(p64, p65, p66)
	local v89 = p64:getComponentFromSpecifier(p66);
	assert(v89, "Could not find component from specifier: " .. tostring(p66));
	local v90 = p64.activeComponents[p65];
	if not v90 then
		return nil;
	end;
	local v91 = v90[v89];
	if not v91 then
		return nil;
	end;
	v91:destroy();
	v90[v89] = nil;
	for v92, v93 in ipairs(p64:getOrderedParents(v89)) do
		local v94 = l__Reflect__2.getOwnMetadata(v93, "identifier");
		if v94 ~= nil then
			p64:removeIdMapping(p65, v91, v94);
		end;
	end;
	for v95, v96 in ipairs((l__Reflect__2.getMetadatas(v89, "flamework:implements"))) do
		for v97, v98 in ipairs(v96) do
			p64:removeIdMapping(p65, v91, v98);
		end;
	end;
	local v99 = 0;
	for v100 in pairs(v90) do
		v99 = v99 + 1;
	end;
	if v99 == 0 then
		p64.activeComponents[p65] = nil;
	end;
end;
function v9.getAllComponents(p67, p68)
	local v101 = p67:getIdFromSpecifier(p68);
	if v101 == nil then
		return {};
	end;
	local v102 = p67.reverseComponentsMapping[v101];
	if not v102 then
		return {};
	end;
	local v103 = {};
	local v104 = #v103;
	for v105 in pairs(v102) do
		v104 = v104 + 1;
		v103[v104] = v105;
	end;
	return v103;
end;
l__Reflect__2.defineMetadata(v9, "identifier", "$c:init@Components");
l__Reflect__2.defineMetadata(v9, "flamework:implements", { "$:flamework@OnInit", "$:flamework@OnStart" });
l__Reflect__2.decorate(v9, "$:flamework@Service", v3.Service, { {
		loadOrder = 0
	} });
l__Reflect__2.decorate(v9, "$:flamework@Controller", v3.Controller, { {
		loadOrder = 0
	} });
return {
	Component = v5, 
	BaseComponent = v6, 
	Components = v9
};
