-- Script Hash: c84e50b6741c6dfede8ff6cac3afd645bbe71accb051b23ea498b769af80c41eb71cace14a16c49f1cc0aff0aa57335f
-- Decompiled with the Synapse X Luau decompiler.

local v1 = _G[script];
local v2 = v1.import(script, v1.getModule(script, "@rbxts", "services"));
local v3 = v1.import(script, v1.getModule(script, "@flamework", "core").out);
local l__Modding__4 = v3.Modding;
local v5 = l__Modding__4.createMetaDecorator("Class");
local v6 = setmetatable({}, {
	__tostring = function()
		return "BaseComponent";
	end
});
v6.__index = v6;
function v6.new(...)
	local v7 = setmetatable({}, v6);
	return v7:constructor(...) and v7;
end;
local u1 = v1.import(script, v1.getModule(script, "@rbxts", "maid").Maid);
function v6.constructor(p1)
	p1.maid = u1.new();
	p1._attributeChangeHandlers = {};
end;
function v6.setInstance(p2, p3, p4)
	p2.instance = p3;
	p2.attributes = p4;
end;
function v6.setAttribute(p5, p6, p7, p8)
	p5.attributes[p6] = p7;
	p5.instance:SetAttribute(p6, p7);
	if p8 then
		return p5.attributes[p6];
	end;
	return p7;
end;
function v6.onAttributeChanged(p9, p10, p11)
	local v8 = p9._attributeChangeHandlers[p10];
	if not v8 then
		v8 = {};
		p9._attributeChangeHandlers[p10] = v8;
	end;
	table.insert(v8, p11);
end;
function v6.destroy(p12)
	p12.maid:Destroy();
end;
local v9 = setmetatable({}, {
	__tostring = function()
		return "Components";
	end
});
v9.__index = v9;
function v9.new(...)
	local v10 = setmetatable({}, v9);
	return v10:constructor(...) and v10;
end;
function v9.constructor(p13)
	p13.components = {};
	p13.classParentCache = {};
	p13.activeComponents = {};
	p13.activeInheritedComponents = {};
	p13.reverseComponentsMapping = {};
end;
local l__Reflect__2 = v3.Reflect;
function v9.onInit(p14)
	local v11 = {};
	for v12, v13 in ipairs((l__Modding__4.getDecorators("$c:init@Component"))) do
		local l__object__14 = v13.object;
		v11[l__object__14] = {
			ctor = l__object__14, 
			config = v13.arguments[1] or {}, 
			identifier = l__Reflect__2.getMetadata(l__object__14, "identifier")
		};
	end;
	p14.components = v11;
end;
local l__RunService__3 = v2.RunService;
local l__CollectionService__4 = v2.CollectionService;
function v9.onStart(p15)
	for v15, v16 in pairs(p15.components) do
		local l__config__17 = v16.config;
		local l__ctor__18 = v16.ctor;
		local l__identifier__19 = v16.identifier;
		if l__config__17.tag ~= nil then
			local u5 = p15:getInstanceGuard(l__ctor__18);
			local u6 = {};
			local u7 = nil;
			local u8 = {};
			local function u9(p16)
				local u10 = nil;
				u10 = p16.DescendantAdded:Connect(function()
					if u5(p16) then
						p15:addComponent(p16, l__ctor__18, true);
						u10:Disconnect();
						u6[p16] = nil;
						u7(p16);
					end;
				end);
				u6[p16] = u10;
			end;
			u7 = function(p17)
				local u11 = nil;
				u11 = p17.DescendantRemoving:Connect(function()
					l__RunService__3.Heartbeat:Wait();
					if not u5(p17) then
						p15:removeComponent(p17, l__ctor__18);
						u11:Disconnect();
						u8[p17] = nil;
						u9(p17);
					end;
				end);
				u8[p17] = u11;
			end;
			local function v20(p18)
				if l__RunService__3:IsServer() or not u5 then
					return p15:addComponent(p18, l__ctor__18);
				end;
				if not u5(p18) then
					u9(p18);
					return;
				end;
				p15:addComponent(p18, l__ctor__18, true);
				u7(p18);
			end;
			l__CollectionService__4:GetInstanceAddedSignal(l__config__17.tag):Connect(v20);
			l__CollectionService__4:GetInstanceRemovedSignal(l__config__17.tag):Connect(function(p19)
				u6[p19] = nil;
				u8[p19] = nil;
				local v21 = u6[p19];
				if v21 ~= nil then
					v21:Disconnect();
				end;
				local v22 = u8[p19];
				if v22 ~= nil then
					v22:Disconnect();
				end;
				p15:removeComponent(p19, l__ctor__18);
			end);
			for v23, v24 in ipairs(l__CollectionService__4:GetTagged(l__config__17.tag)) do
				p15:safeCall("Failed to instantiate '" .. l__identifier__19 .. "' for " .. tostring(v24), function()
					return v20(v24);
				end);
			end;
		end;
	end;
end;
function v9.getParentConstructor(p20, p21)
	local v25 = getmetatable(p21);
	if not v25 or type(v25) ~= "table" then
		return;
	end;
	return rawget(v25, "__index");
end;
function v9.getOrderedParents(p22, p23, p24)
	if p24 == nil then
		p24 = true;
	end;
	local v26 = p22.classParentCache[p23];
	if v26 then
		return v26;
	end;
	local v27 = { p23 };
	local v28 = p23;
	while true do
		v28 = p22:getParentConstructor(v28);
		if v28 == nil then
			break;
		end;
		if not p24 or v28 ~= v6 then
			table.insert(v27, v28);
		end;	
	end;
	p22.classParentCache[p23] = v27;
	return v27;
end;
function v9.getAttributeGuards(p25, p26)
	local v29 = {};
	local v30 = p25.components[p26];
	if v30 then
		if v30.config.attributes ~= nil then
			for v31, v32 in pairs(v30.config.attributes) do
				v29[v31] = v32;
			end;
		end;
		local v33 = getmetatable(p26);
		if v33.__index ~= nil then
			for v34, v35 in pairs(p25:getAttributeGuards(v33.__index)) do
				if v29[v34] == nil then
					v29[v34] = v35;
				end;
			end;
		end;
	end;
	return v29;
end;
function v9.getAttributes(p27, p28, p29, p30)
	local v36 = p28:GetAttributes();
	local v37 = {};
	local l__defaults__38 = p29.config.defaults;
	for v39, v40 in pairs(p30) do
		local v41 = v36[v39];
		if not v40(v41) then
			local v42 = l__defaults__38;
			if v42 ~= nil then
				v42 = v42[v39];
			end;
			if v42 ~= nil then
				v37[v39] = l__defaults__38[v39];
				p28:SetAttribute(v39, l__defaults__38[v39]);
			else
				error(p28:GetFullName() .. " has invalid attribute '" .. v39 .. "' for '" .. p29.identifier .. "'");
			end;
		else
			v37[v39] = v41;
		end;
	end;
	return v37;
end;
function v9.getInstanceGuard(p31, p32)
	local v43 = nil;
	local v44 = p31.components[p32];
	if v44 then
		if v44.config.instanceGuard ~= nil then
			return v44.config.instanceGuard;
		end;
		v43 = getmetatable(p32);
		if v43.__index == nil then
			return;
		end;
	else
		return;
	end;
	return p31:getInstanceGuard(v43.__index);
end;
function v9.safeCall(p33, p34, p35)
	task.spawn(function()
		xpcall(p35, function(p36)
			if type(p36) == "string" then
				local v45 = debug.traceback(p36, 2);
				warn(p34);
				warn(v45);
				return;
			end;
			warn(p34);
			warn(p36);
			warn(debug.traceback(nil, 2));
		end);
	end);
end;
local l__Flamework__12 = v3.Flamework;
function v9.setupComponent(p37, p38, p39, p40, p41, p42)
	local l__config__46 = p42.config;
	local l__identifier__47 = p42.identifier;
	p40:setInstance(p38, p39);
	p41();
	if l__Flamework__12._implements(p40, "$:flamework@OnStart") then
		p37:safeCall("Component '" .. l__identifier__47 .. "' failed to start " .. p38:GetFullName(), function()
			return p40:onStart();
		end);
	end;
	l__Modding__4.addListener(p40);
	p40.maid:GiveTask(function()
		return l__Modding__4.removeListener(p40);
	end);
	if l__config__46.refreshAttributes == nil or l__config__46.refreshAttributes then
		local v48 = table.clone(p39);
		for v49, v50 in pairs((p37:getAttributeGuards(p42.ctor))) do
			if type(v49) == "string" then
				p40.maid:GiveTask(p38:GetAttributeChangedSignal(v49):Connect(function()
					local v51 = p40._attributeChangeHandlers[v49];
					local v52 = p38:GetAttribute(v49);
					if v50(v52) then
						if v51 then
							for v53, v54 in ipairs(v51) do
								p37:safeCall("Component '" .. l__identifier__47 .. "' failed to call onAttributeChanged for " .. v49, function()
									return v54(v52, v48[v49]);
								end);
							end;
						end;
						p40.attributes[v49] = v52;
						v48[v49] = v52;
					end;
				end));
			end;
		end;
	end;
end;
function v9.getComponentFromSpecifier(p43, p44)
	if type(p44) ~= "string" then
		return p44;
	end;
	return l__Reflect__2.idToObj[p44];
end;
function v9.getIdFromSpecifier(p45, p46)
	if p46 == nil then
		return;
	end;
	if type(p46) == "string" then
		return p46;
	end;
	return l__Reflect__2.getMetadata(p46, "identifier");
end;
function v9.addIdMapping(p47, p48, p49, p50)
	local v55 = p50[p49];
	if not v55 then
		v55 = {};
		p50[p49] = v55;
	end;
	local v56 = p47.reverseComponentsMapping[p49];
	if not v56 then
		v56 = {};
		p47.reverseComponentsMapping[p49] = v56;
	end;
	v55[p48] = true;
	v56[p48] = true;
end;
function v9.removeIdMapping(p51, p52, p53, p54)
	local v57 = p51.activeInheritedComponents[p52];
	if not v57 then
		return nil;
	end;
	local v58 = v57[p54];
	if not v58 then
		return nil;
	end;
	local v59 = p51.reverseComponentsMapping[p54];
	if not v59 then
		return nil;
	end;
	v58[p53] = nil;
	v59[p53] = nil;
	local v60 = 0;
	for v61 in pairs(v59) do
		v60 = v60 + 1;
	end;
	if v60 == 0 then
		p51.reverseComponentsMapping[p54] = nil;
	end;
	local v62 = 0;
	for v63 in pairs(v58) do
		v62 = v62 + 1;
	end;
	if v62 == 0 then
		v57[p54] = nil;
	end;
	local v64 = 0;
	for v65 in pairs(v57) do
		v64 = v64 + 1;
	end;
	if v64 == 0 then
		p51.activeInheritedComponents[p52] = nil;
	end;
end;
function v9.getComponent(p55, p56, p57)
	local v66 = p55:getComponentFromSpecifier(p57);
	assert(v66, "Could not find component from specifier: " .. tostring(p57));
	local v67 = p55.activeComponents[p56];
	if not v67 then
		return nil;
	end;
	return v67[v66];
end;
function v9.getComponents(p58, p59, p60)
	local v68 = p58:getIdFromSpecifier(p60);
	if v68 == nil then
		return {};
	end;
	local v69 = p58.activeInheritedComponents[p59];
	if not v69 then
		return {};
	end;
	local v70 = v69[v68];
	if not v70 then
		return {};
	end;
	local v71 = {};
	local v72 = #v71;
	for v73 in pairs(v70) do
		v72 = v72 + 1;
		v71[v72] = v73;
	end;
	return v71;
end;
function v9.addComponent(p61, p62, p63, p64)
	local v74 = p61:getComponentFromSpecifier(p63);
	assert(v74, "Could not find component from specifier: " .. tostring(p63));
	local v75 = p61.components[v74];
	assert(v75, "Provided componentSpecifier does not exist");
	if p64 ~= true then
		local v76 = p61:getInstanceGuard(v74);
		if v76 ~= nil then
			assert(v76(p62), p62:GetFullName() .. " did not pass instance guard check for '" .. v75.identifier .. "'");
		end;
	end;
	local v77 = p61.activeComponents[p62];
	if not v77 then
		v77 = {};
		p61.activeComponents[p62] = v77;
	end;
	local v78 = p61.activeInheritedComponents[p62];
	if not v78 then
		v78 = {};
		p61.activeInheritedComponents[p62] = v78;
	end;
	local v79 = v77[v74];
	if v79 ~= nil then
		return v79;
	end;
	local v80 = l__Modding__4.createDeferredDependency(v74);
	local v81 = v80[1];
	v77[v74] = v81;
	for v82, v83 in ipairs(p61:getOrderedParents(v74)) do
		local v84 = l__Reflect__2.getOwnMetadata(v83, "identifier");
		if v84 ~= nil then
			p61:addIdMapping(v81, v84, v78);
		end;
	end;
	for v85, v86 in ipairs((l__Reflect__2.getMetadatas(v74, "flamework:implements"))) do
		for v87, v88 in ipairs(v86) do
			p61:addIdMapping(v81, v88, v78);
		end;
	end;
	p61:setupComponent(p62, p61:getAttributes(p62, v75, (p61:getAttributeGuards(v74))), v81, v80[2], v75);
	return v81;
end;
function v9.removeComponent(p65, p66, p67)
	local v89 = p65:getComponentFromSpecifier(p67);
	assert(v89, "Could not find component from specifier: " .. tostring(p67));
	local v90 = p65.activeComponents[p66];
	if not v90 then
		return nil;
	end;
	local v91 = v90[v89];
	if not v91 then
		return nil;
	end;
	v91:destroy();
	v90[v89] = nil;
	for v92, v93 in ipairs(p65:getOrderedParents(v89)) do
		local v94 = l__Reflect__2.getOwnMetadata(v93, "identifier");
		if v94 ~= nil then
			p65:removeIdMapping(p66, v91, v94);
		end;
	end;
	for v95, v96 in ipairs((l__Reflect__2.getMetadatas(v89, "flamework:implements"))) do
		for v97, v98 in ipairs(v96) do
			p65:removeIdMapping(p66, v91, v98);
		end;
	end;
	local v99 = 0;
	for v100 in pairs(v90) do
		v99 = v99 + 1;
	end;
	if v99 == 0 then
		p65.activeComponents[p66] = nil;
	end;
end;
function v9.getAllComponents(p68, p69)
	local v101 = p68:getIdFromSpecifier(p69);
	if v101 == nil then
		return {};
	end;
	local v102 = p68.reverseComponentsMapping[v101];
	if not v102 then
		return {};
	end;
	local v103 = {};
	local v104 = #v103;
	for v105 in pairs(v102) do
		v104 = v104 + 1;
		v103[v104] = v105;
	end;
	return v103;
end;
l__Reflect__2.defineMetadata(v9, "identifier", "$c:init@Components");
l__Reflect__2.defineMetadata(v9, "flamework:implements", { "$:flamework@OnInit", "$:flamework@OnStart" });
l__Reflect__2.decorate(v9, "$:flamework@Service", v3.Service, { {
		loadOrder = 0
	} });
l__Reflect__2.decorate(v9, "$:flamework@Controller", v3.Controller, { {
		loadOrder = 0
	} });
return {
	Component = v5, 
	BaseComponent = v6, 
	Components = v9
};
