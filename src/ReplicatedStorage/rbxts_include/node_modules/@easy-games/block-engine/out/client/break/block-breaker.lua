-- Script Hash: a1ea155f3853cf941b5769dc3caf9f1b51a7c36def9f9aacd30d3c28759628096520e555ef0ee48e2be692019a83ee8e
-- Decompiled with the Synapse X Luau decompiler.

local v1 = _G[script];
local v2 = v1.import(script, v1.getModule(script, "@easy-games", "game-core").out);
local v3 = v1.import(script, v1.getModule(script, "@rbxts", "services"));
local v4 = v1.import(script, script.Parent.Parent.Parent, "remotes");
local v5 = setmetatable({}, {
	__tostring = function()
		return "BlockBreaker";
	end
});
v5.__index = v5;
function v5.new(...)
	local v6 = setmetatable({}, v5);
	return v6:constructor(...) and v6;
end;
local u1 = v1.import(script, v1.getModule(script, "@rbxts", "maid").Maid);
local l__BreakEffect__2 = v1.import(script, script.Parent, "break-effect").BreakEffect;
local u3 = v1.import(script, v1.getModule(script, "@rbxts", "roact").src);
local u4 = v1.import(script, v1.getModule(script, "@rbxts", "signal"));
local l__BlockHighlighter__5 = v1.import(script, script.Parent.Parent, "highlight", "block-highlighter").BlockHighlighter;
local l__BlockSelectorMode__6 = v1.import(script, script.Parent.Parent, "select", "block-selector").BlockSelectorMode;
local l__BlockEngineRemotes__7 = v4.BlockEngineRemotes;
local l__Players__8 = v3.Players;
local l__PositionUtil__9 = v1.import(script, script.Parent.Parent.Parent, "shared", "lib", "position-util").PositionUtil;
function v5.constructor(p1, p2)
	p1.clientManager = p2;
	p1.maid = u1.new();
	p1.clientPredictedBlockBreaks = {};
	p1.breakEffect = l__BreakEffect__2.new();
	p1.lastHitTime = 0;
	p1.blockHealth = -1;
	p1.blockPredictDestroyed = false;
	p1.healthbarProgressRef = u3.createRef();
	p1.healthbarMaid = u1.new();
	p1.onBreak = u4.new();
	p1.blockHighligher = l__BlockHighlighter__5.new(p2, l__BlockSelectorMode__6.SELECT);
	l__BlockEngineRemotes__7.Client:WaitFor("RemoteName"):andThen(function(p3)
		p3:Connect(function(p4)
			p1.clientPredictedBlockBreaks[p4.blockRef.blockPosition] = nil;
		end);
		p3:Connect(function(p5)
			if p5.player ~= l__Players__8.LocalPlayer then
				p1.breakEffect:playBreak(p5.blockType, p5.blockRef.blockPosition);
				if p1.healthbarBlockRef and l__PositionUtil__9.isEqual(p5.blockRef.blockPosition, p1.healthbarBlockRef.blockPosition) then
					p1.healthbarMaid:DoCleaning();
				end;
			end;
		end);
	end);
end;
local l__BlockEngine__10 = v1.import(script, script.Parent.Parent.Parent).BlockEngine;
local l__BlockEngineClientEvents__11 = v1.import(script, script.Parent.Parent, "block-engine-client-events").BlockEngineClientEvents;
local l__AnimationUtil__12 = v2.AnimationUtil;
local l__AnimationId__13 = v1.import(script, script.Parent.Parent.Parent, "shared", "animation", "animation-id").AnimationId;
local l__DamageBlockResponse__14 = v4.DamageBlockResponse;
local u15 = v1.import(script, v1.getModule(script, "@rbxts", "inspect").inspect);
function v5.hitBlock(p6, p7, p8)
	if l__Players__8.LocalPlayer:GetAttribute("DenyBlockBreak") == true then
		return nil;
	end;
	local v7 = p6.clientManager:getBlockSelector():getMouseInfo(l__BlockSelectorMode__6.SELECT, {
		ray = p8
	});
	local v8 = v7;
	if v8 ~= nil then
		v8 = v8.target;
	end;
	if v8 then
		local l__target__9 = v7.target;
		if l__BlockEngine__10:isBlockBreakable(l__target__9.blockRef, l__Players__8.LocalPlayer) then
			if l__BlockEngineClientEvents__11.DamageBlock:fire(l__target__9.blockInstance.Name, l__target__9.blockRef.blockPosition, l__target__9.blockInstance):isCancelled() then
				return nil;
			end;
			local v10 = u1.new();
			p6.lastHitTime = tick();
			if p6.blockHealth == -1 or l__target__9.blockRef.blockPosition ~= p6.breakingBlockPosition or p6.blockPredictDestroyed then
				p6.blockPredictDestroyed = false;
				local v11 = l__BlockEngine__10:getStore():getBlockData(l__target__9.blockRef.blockPosition);
				if not v11 then
					return nil;
				end;
				local v12 = v11:GetAttribute(l__Players__8.LocalPlayer.Name .. "_Health");
				if v12 == nil then
					v12 = v7.target.blockInstance:GetAttribute("Health");
				end;
				p6.blockHealth = v12;
				p6.breakingBlockPosition = l__target__9.blockRef.blockPosition;
			end;
			local v13 = l__BlockEngine__10:calculateBlockDamage(l__Players__8.LocalPlayer, v7.target.blockRef);
			p6.blockHealth = p6.blockHealth - v13;
			if p6.blockHealth < 0 then
				p6.blockHealth = 0;
			end;
			local u16 = true;
			p6.healthbarMaid:GiveTask(function()
				u16 = false;
			end);
			v10:GiveTask(function()
				if u16 then
					p6.blockHealth = p6.blockHealth + v13;
				end;
			end);
			p6:updateHealthbar(v7.target.blockRef, p6.blockHealth, v7.target.blockInstance:GetAttribute("MaxHealth"), v13);
			local u17 = l__AnimationUtil__12.playAnimation(l__Players__8.LocalPlayer, l__BlockEngine__10:getAnimationController():getAssetId(l__AnimationId__13.BREAK_BLOCK));
			p7:GiveTask(function()
				if u17 ~= nil then
					u17:Stop();
				end;
				if u17 ~= nil then
					u17:Destroy();
				end;
			end);
			p6.onBreak:Fire();
			local v14 = false;
			if p6.blockHealth <= 0 then
				v14 = true;
				p6.blockPredictDestroyed = true;
				p6.breakEffect:playBreak(v7.target.blockInstance.Name, v7.target.blockRef.blockPosition, l__Players__8.LocalPlayer);
				p6.healthbarMaid:DoCleaning();
				local l__blockInstance__15 = v7.target.blockInstance;
				local v16 = l__blockInstance__15:GetAttribute("BlockUUID");
				local l__blockRef__17 = v7.target.blockRef;
				p6.clientPredictedBlockBreaks[l__blockRef__17.blockPosition] = true;
				l__BlockEngine__10:destroyBlock(l__blockRef__17);
				local l__Name__18 = l__blockInstance__15.Name;
				v10:GiveTask(function()
					if p6.clientPredictedBlockBreaks[l__blockRef__17.blockPosition] ~= nil then
						l__BlockEngine__10:placeBlock(l__Name__18, l__blockRef__17.blockPosition, {
							blockUUID = v16
						});
						p6.clientPredictedBlockBreaks[l__blockRef__17.blockPosition] = nil;
					end;
				end);
			else
				p6.breakEffect:playHit(v7.target.blockInstance.Name, v7.target.blockRef.blockPosition, l__Players__8.LocalPlayer);
			end;
			local l__blockRef__19 = v7.target.blockRef;
			local l__blockInstance__20 = l__target__9.blockInstance;
			l__BlockEngineRemotes__7.Client:Get("RemoteName"):CallServerAsync({
				blockRef = v7.target.blockRef, 
				hitPosition = v7.target.hitPosition, 
				hitNormal = v7.target.hitNormal
			}):andThen(function(p9)
				if p9 ~= l__DamageBlockResponse__14.DESTROYED and v14 then
					v10:DoCleaning();
				end;
				if not p9 or p9 == l__DamageBlockResponse__14.FAILED then
					error("Rejected: " .. u15(p9));
				end;
			end):catch(function(p10)
				warn("Failed block place:", u15(p10));
				warn(p10);
				v10:DoCleaning();
				if p6.clientPredictedBlockBreaks[l__blockRef__19.blockPosition] ~= nil then
					l__BlockEngine__10:placeBlock(l__blockInstance__20.Name, l__blockRef__19.blockPosition);
					p6.clientPredictedBlockBreaks[l__blockRef__19.blockPosition] = nil;
				end;
			end);
		end;
	end;
end;
local l__UserInputService__21 = v3.UserInputService;
local l__RunService__22 = v3.RunService;
local l__Workspace__23 = v3.Workspace;
local l__ContextActionService__24 = v3.ContextActionService;
function v5.enable(p11)
	print("enabling block breaker!");
	p11.blockHighligher:enable();
	p11.maid:GiveTask(function()
		p11.blockHighligher:disable();
	end);
	if l__UserInputService__21.TouchEnabled then
		local v18 = u1.new();
		p11.maid:GiveTask(v18);
		p11.maid:GiveTask(l__UserInputService__21.TouchStarted:Connect(function(p12, p13)
			if p13 then
				return nil;
			end;
			local v19 = u1.new();
			local u25 = true;
			v19:GiveTask(function()
				u25 = false;
				l__RunService__22:UnbindFromRenderStep("block-break-touch");
			end);
			v19:GiveTask(l__UserInputService__21.TouchEnded:Connect(function(p14, p15)
				if p14 ~= p12 then
					return nil;
				end;
				v19:DoCleaning();
			end));
			local u26 = false;
			v19:GiveTask(l__UserInputService__21.TouchMoved:Connect(function(p16, p17)
				if p16 ~= p12 or u26 then
					return nil;
				end;
				local v20 = l__Players__8.LocalPlayer.Character;
				if v20 ~= nil then
					v20 = v20:FindFirstChildWhichIsA("Humanoid");
					if v20 ~= nil then
						v20 = v20.MoveDirection;
					end;
				end;
				if v20 ~= nil and v20 ~= Vector3.new() then
					v19:DoCleaning();
				end;
			end));
			p11.maid:GiveTask(v19);
			local u27 = 0;
			local function u28(p18)
				u26 = true;
				while true do
					local v21 = nil;
					if l__Workspace__23.CurrentCamera then
						v21 = l__Workspace__23.CurrentCamera:ScreenPointToRay(p18.Position.X, p18.Position.Y);
					end;
					p11:hitBlock(v19, v21);
					local v22 = task.wait(v5.COOLDOWN);
					if v22 ~= 0 and v22 == v22 and v22 then
						v22 = u25;
					end;
					if v22 == 0 then
						break;
					end;
					if v22 ~= v22 then
						break;
					end;
					if not v22 then
						break;
					end;				
				end;
			end;
			l__RunService__22:BindToRenderStep("block-break-touch", Enum.RenderPriority.Input.Value, function(p19)
				u27 = u27 + p19;
				if u27 >= 0.25 then
					l__RunService__22:UnbindFromRenderStep("block-break-touch");
					v18:DoCleaning();
					v18:GiveTask(v19);
					p11.blockHighligher:setInputObject(p12);
					v19:GiveTask(function()
						p11.blockHighligher:setInputObject(nil);
					end);
					task.spawn(function()
						u28(p12);
					end);
				end;
			end);
		end));
	end;
	local u29 = u1.new();
	l__ContextActionService__24:BindAction("block-break", function(p20, p21, p22)
		if p21 == Enum.UserInputState.Begin then
			u29:DoCleaning();
			local u30 = true;
			u29:GiveTask(function()
				u30 = false;
			end);
			local v23 = tick() - p11.lastHitTime;
			if v23 < v5.COOLDOWN then
				wait(v5.COOLDOWN - v23);
				if not u30 then
					return nil;
				end;
			end;
			while true do
				p11:hitBlock(u29);
				if not { wait(v5.COOLDOWN) } then
					break;
				end;
				if not u30 then
					break;
				end;			
			end;
		end;
	end, false, Enum.UserInputType.MouseButton1);
	p11.maid:GiveTask(l__UserInputService__21.InputEnded:Connect(function(p23)
		if p23.UserInputType == Enum.UserInputType.MouseButton1 then
			u29:DoCleaning();
		end;
	end));
	p11.maid:GiveTask(function()
		l__ContextActionService__24:UnbindAction("block-break");
		u29:DoCleaning();
	end);
end;
local u31 = v1.import(script, v1.getModule(script, "@rbxts", "make"));
local l__GameQueryUtil__32 = v2.GameQueryUtil;
local l__TweenService__33 = v3.TweenService;
function v5.updateHealthbar(p24, p25, p26, p27, p28)
	local v24 = not p24.healthbarPart;
	if not v24 then
		local v25 = p24.healthbarBlockRef;
		if v25 ~= nil then
			v25 = v25.blockPosition;
		end;
		v24 = v25 ~= p25.blockPosition;
	end;
	if v24 then
		p24.healthbarMaid:DoCleaning();
		p24.healthbarBlockRef = p25;
		p24.healthbarPart = u31("Part", {
			Size = Vector3.new(1, 1, 1), 
			CFrame = CFrame.new(l__PositionUtil__9.convertToWorldPosition(p25.blockPosition)), 
			Transparency = 1, 
			Anchored = true, 
			CanCollide = false, 
			Parent = l__Workspace__23
		});
		l__GameQueryUtil__32:setQueryIgnored(p24.healthbarPart, true);
		local u34 = true;
		local u35 = u3.mount(u3.createElement("BillboardGui", {
			Adornee = p24.healthbarPart, 
			Size = UDim2.fromScale(4, 0.2), 
			StudsOffset = Vector3.new(0, 2.5, 0), 
			MaxDistance = 40, 
			AlwaysOnTop = true
		}, { u3.createElement("Frame", {
				Size = UDim2.fromScale(1, 1), 
				BackgroundColor3 = Color3.fromRGB(0, 0, 0), 
				BackgroundTransparency = 0.3, 
				BorderSizePixel = 0
			}, { u3.createElement("Frame", {
					[u3.Ref] = p24.healthbarProgressRef, 
					Size = UDim2.fromScale(p26 / p27, 1), 
					BackgroundColor3 = Color3.fromRGB(39, 231, 68), 
					BorderSizePixel = 0
				}) }) }), p24.healthbarPart);
		p24.healthbarMaid:GiveTask(function()
			u34 = false;
			p24.healthbarBlockRef = nil;
			u3.unmount(u35);
			local l__healthbarPart__26 = p24.healthbarPart;
			if l__healthbarPart__26 ~= nil then
				l__healthbarPart__26:Destroy();
			end;
			p24.healthbarPart = nil;
		end);
		v1.Promise.delay(5):andThen(function()
			if u34 then
				p24.healthbarMaid:DoCleaning();
			end;
		end);
	end;
	l__TweenService__33:Create(p24.healthbarProgressRef:getValue(), TweenInfo.new(v5.COOLDOWN, Enum.EasingStyle.Quad), {
		Size = UDim2.fromScale(math.max((p26 - p28) / p27, 0), 1)
	}):Play();
end;
function v5.disable(p29)
	p29.maid:DoCleaning();
end;
v5.COOLDOWN = 0.3;
return {
	BlockBreaker = v5
};
