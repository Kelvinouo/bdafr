-- Decompiled with the Synapse X Luau decompiler.

local v1 = _G[script];
local l__GameQueryUtil__2 = v1.import(script, v1.getModule(script, "@easy-games", "game-core").out).GameQueryUtil;
local v3 = v1.import(script, v1.getModule(script, "@rbxts", "make"));
local v4 = v1.import(script, v1.getModule(script, "@rbxts", "services"));
local v5 = v1.import(script, script.Parent.Parent.Parent);
local l__BLOCK_SIZE__6 = v1.import(script, script.Parent.Parent.Parent, "shared", "block", "block-constants").BLOCK_SIZE;
local l__PositionUtil__7 = v1.import(script, script.Parent.Parent.Parent, "shared", "lib", "position-util").PositionUtil;
local v8 = {};
local v9 = setmetatable({}, {
	__index = v8
});
v9.PLACE = 0;
v8[0] = "PLACE";
v9.SELECT = 1;
v8[1] = "SELECT";
local v10 = setmetatable({}, {
	__tostring = function()
		return "BlockSelector";
	end
});
v10.__index = v10;
function v10.new(...)
	local v11 = setmetatable({}, v10);
	return v11:constructor(...) and v11;
end;
local l__Players__1 = v4.Players;
function v10.constructor(p1, p2)
	if p2 then
		p1.mouse = p2;
		return;
	end;
	p1.mouse = l__Players__1.LocalPlayer:GetMouse();
end;
local l__Workspace__2 = v4.Workspace;
local u3 = 6 * l__BLOCK_SIZE__6;
local l__CollectionService__4 = v4.CollectionService;
local u5 = 6 * l__BLOCK_SIZE__6;
local l__BlockEngine__6 = v5.BlockEngine;
local l__GreedyBlockHandler__7 = v5.GreedyBlockHandler;
function v10.getMouseInfo(p3, p4, p5)
	local v12 = l__Players__1.LocalPlayer.Character;
	if v12 ~= nil then
		v12 = v12.PrimaryPart;
	end;
	if not v12 then
		return nil;
	end;
	local v13 = RaycastParams.new();
	v13.FilterType = Enum.RaycastFilterType.Blacklist;
	if l__Players__1.LocalPlayer.Character then
		v13.FilterDescendantsInstances = { l__Players__1.LocalPlayer.Character };
	end;
	local function v14()
		local v15 = p5;
		if v15 ~= nil then
			v15 = v15.ray;
		end;
		local v16 = v15;
		if v16 == nil then
			v16 = p3.mouse.UnitRay;
		end;
		local v17 = l__Workspace__2:Raycast(v16.Origin, v16.Direction * (u3 * 3.5), v13);
		while true do
			local v18 = v17;
			if v18 then
				v18 = l__CollectionService__4:HasTag(v17.Instance, "block:no-collision");
				if not v18 then
					v18 = l__GameQueryUtil__2:isQueryIgnored(v17.Instance);
					if not v18 then
						v18 = false;
						if p4 == v9.PLACE then
							v18 = v17.Instance:GetAttribute("BlockEngine_Select_IgnorePlaceMode");
						end;
					end;
				end;
			end;
			if v18 == 0 then
				break;
			end;
			if v18 ~= v18 then
				break;
			end;
			if v18 == "" then
				break;
			end;
			if not v18 then
				break;
			end;
			local v19 = {};
			local v20 = #v19;
			local v21 = v13.FilterDescendantsInstances;
			local v22 = #v21;
			table.move(v21, 1, v22, v20 + 1, v19);
			v19[v20 + v22 + 1] = v17.Instance;
			v13.FilterDescendantsInstances = v19;
			v17 = l__Workspace__2:Raycast(v16.Origin, v16.Direction * (u3 * 3.5), v13);		
		end;
		return v17;
	end;
	local l__Position__23 = l__Players__1.LocalPlayer.Character.PrimaryPart.Position;
	local v24 = v14();
	local v25 = u3;
	if p4 == v9.SELECT then
		v25 = u5;
	end;
	local v26 = v24 and v24.Instance:IsA("BasePart");
	if v26 then
		local v27 = p5;
		if v27 ~= nil then
			v27 = v27.searchOutward;
		end;
		v26 = v27 ~= true;
	end;
	if v26 and (v24.Position - l__Position__23).Magnitude <= v25 then
		local v28 = l__BlockEngine__6:getBlockInstanceFromChild(v24.Instance);
		if v28 then
			local v29 = l__BlockEngine__6:getHandlerRegistry():getHandler(v28.Name);
			local v30 = v29;
			if v30 ~= nil then
				v30 = v30:getBlockMeta();
			end;
			if p4 == v9.PLACE then
				local v31 = v30;
				if v31 ~= nil then
					v31 = v31.denyPlaceOn;
				end;
				if v31 then
					return nil;
				else
					local v32 = v24.Position - v24.Normal * 0.1;
					local v33 = v32 / l__BLOCK_SIZE__6;
					local v34 = nil;
					if v29 and not v1.instanceof(v29, l__GreedyBlockHandler__7) then
						local v35, v36, v37 = ipairs(v29:getContainedPositions(v28));
						while true do
							v35(v36, v37);
							if not v35 then
								break;
							end;
							local v38 = v34;
							if v38 ~= nil then
								v38 = (v38 - v33).Magnitude;
							end;
							local v39 = v38;
							if v39 == nil then
								v39 = math.huge;
							end;
							if (v36 - v33).Magnitude < v39 then
								v34 = v36;
							end;						
						end;
					end;
					if not v34 then
						v34 = l__PositionUtil__7.convertToBlockPosition(v32);
					end;
					return {
						target = {
							blockInstance = v28, 
							blockRef = {
								blockPosition = v34
							}, 
							hitPosition = v24.Position, 
							hitNormal = v24.Normal
						}, 
						placementPosition = v34 + v24.Normal.Unit
					};
				end;
			else
				v32 = v24.Position - v24.Normal * 0.1;
				v33 = v32 / l__BLOCK_SIZE__6;
				v34 = nil;
				if v29 and not v1.instanceof(v29, l__GreedyBlockHandler__7) then
					v35, v36, v37 = ipairs(v29:getContainedPositions(v28));
					while true do
						v35(v36, v37);
						if not v35 then
							break;
						end;
						v38 = v34;
						if v38 ~= nil then
							v38 = (v38 - v33).Magnitude;
						end;
						v39 = v38;
						if v39 == nil then
							v39 = math.huge;
						end;
						if (v36 - v33).Magnitude < v39 then
							v34 = v36;
						end;					
					end;
				end;
				if not v34 then
					v34 = l__PositionUtil__7.convertToBlockPosition(v32);
				end;
				return {
					target = {
						blockInstance = v28, 
						blockRef = {
							blockPosition = v34
						}, 
						hitPosition = v24.Position, 
						hitNormal = v24.Normal
					}, 
					placementPosition = v34 + v24.Normal.Unit
				};
			end;
		end;
	end;
	if p4 == v9.PLACE then
		local v40 = nil;
		local v41 = l__Workspace__2:GetAttribute("WorldNormal") or Vector3.new(0, 1, 0);
		local v42 = 1;
		local v43 = false;
		while true do
			if v43 then
				v42 = v42 + 1;
			else
				v43 = true;
			end;
			if not (v42 <= 3) then
				break;
			end;
			local v44 = l__BlockEngine__6:getBlockPosition(l__Position__23 - v41 * l__BLOCK_SIZE__6 * v42);
			if l__BlockEngine__6:getStore():getBlockAt(v44) then
				v40 = {
					blockPosition = v44
				};
				break;
			end;		
		end;
		if not v40 then
			local v45 = nil;
			local v46 = nil;
			local v47 = p5;
			if v47 ~= nil then
				v47 = v47.allowVoidSave;
			end;
			if v47 then
				local v48 = { Vector3.new(1, 0, 0), Vector3.new(-1, 0, 0), Vector3.new(0, 0, 1), Vector3.new(0, 0, -1), Vector3.new(1, 0, 1), Vector3.new(-1, 0, -1), Vector3.new(-1, 0, 1), Vector3.new(1, 0, -1) };
				local v49 = 1;
				local v50 = false;
				while true do
					if v50 then
						v49 = v49 + 1;
					else
						v50 = true;
					end;
					if not (v49 <= 3) then
						break;
					end;
					local v51 = l__BlockEngine__6:getBlockPosition(l__Position__23 - v41 * l__BLOCK_SIZE__6 * v49);
					local v52, v53, v54 = ipairs(v48);
					while true do
						v52(v53, v54);
						if not v52 then
							break;
						end;
						v54 = v52;
						if l__BlockEngine__6:getStore():getBlockAt(v51 + v53) ~= nil then
							return {
								target = nil, 
								placementPosition = v51
							};
						end;					
					end;				
				end;
				v45 = nil;
				v46 = v45;
				return v46;
			else
				v45 = nil;
				v46 = v45;
				return v46;
			end;
		end;
		local v55 = v3("Part", {
			Size = Vector3.new(30, 1, 30) * l__BLOCK_SIZE__6, 
			CFrame = CFrame.new(v40.blockPosition * l__BLOCK_SIZE__6) * CFrame.Angles(v41.Z, 0, v41.X), 
			Anchored = true, 
			Transparency = 1, 
			CanCollide = false, 
			Parent = l__Workspace__2
		});
		local v56 = {};
		local v57 = 0;
		local v58, v59, v60 = ipairs((l__Players__1:GetPlayers()));
		while true do
			v58(v59, v60);
			if not v58 then
				break;
			end;
			v60 = v58;
			local l__Character__61 = v59.Character;
			if l__Character__61 ~= nil then
				v57 = v57 + 1;
				v56[v57] = l__Character__61;
			end;		
		end;
		local v62 = {};
		table.move(v56, 1, #v56, #v62 + 1, v62);
		v13.FilterDescendantsInstances = v62;
		local v63 = p5;
		if v63 ~= nil then
			v63 = v63.searchOutward;
		end;
		if v63 then
			v13.FilterDescendantsInstances = { v55 };
			v13.FilterType = Enum.RaycastFilterType.Whitelist;
		end;
		local v64 = v14();
		v55:Destroy();
		local v65 = v64;
		if v65 ~= nil then
			v65 = v65.Instance;
		end;
		if v65 == v55 then
			local v66 = l__BlockEngine__6:getBlockPosition(l__BlockEngine__6:snapPosition(v64.Position - v41 * (l__BLOCK_SIZE__6 / 2)));
			local v67 = v40.blockPosition;
			if l__BlockEngine__6:getStore():getBlockAt(v67) then
				local v68 = 0;
				local v69 = false;
				while true do
					if v69 then
						v68 = v68 + 1;
					else
						v69 = true;
					end;
					if not (v68 < 20) then
						break;
					end;
					v67 = v67 + (v66 - v67).Unit / 2;
					if not l__BlockEngine__6:getStore():getBlockAt(l__BlockEngine__6:snapPosition(v67)) then
						break;
					end;				
				end;
			end;
			local v70 = l__BlockEngine__6:snapPosition(v67);
			if l__BlockEngine__6:getStore():getBlockAt(v70) == nil then
				return {
					target = nil, 
					placementPosition = v70
				};
			end;
		end;
	end;
	return nil;
end;
return {
	BlockSelectorMode = v9, 
	BlockSelector = v10
};
