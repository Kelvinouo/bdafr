-- Script Hash: 033ee2a2cd8230a92c7cd09706fdd173a1512270a112e2c8058fd34c78151dcac5a47c474d72e115925ee96dd2f521ad
-- Decompiled with the Synapse X Luau decompiler.

local v1 = _G[script];
local v2 = v1.import(script, v1.getModule(script, "@rbxts", "log").out);
local l__default__3 = v2.default;
local v4 = setmetatable({}, {
	__tostring = function()
		return "Analytics";
	end
});
v4.__index = v4;
function v4.new(...)
	local v5 = setmetatable({}, v4);
	return v5:constructor(...) and v5;
end;
local function u1(p1)
	return p1;
end;
function v4.constructor(p2, p3, p4)
	p2.closing = false;
	local v6 = false;
	if p3 ~= "" then
		v6 = p3;
	end;
	assert(v6, "You must pass your Segment project's write key.");
	p2.queue = {};
	p2.writeKey = p3;
	local v7 = p4;
	if v7 ~= nil then
		v7 = v7.host;
	end;
	local v8 = v7;
	if v8 == nil then
		v8 = "https://api.segment.io";
	end;
	p2.host = u1(v8);
	local v9 = p4;
	if v9 ~= nil then
		v9 = v9.path;
	end;
	local v10 = v9;
	if v10 == nil then
		v10 = "/v1/batch";
	end;
	p2.path = u1(v10);
	local v11 = p4;
	if v11 ~= nil then
		v11 = v11.flushAt;
	end;
	local v12 = v11;
	if v12 == nil then
		v12 = 20;
	end;
	p2.flushAt = v12;
	local v13 = p4;
	if v13 ~= nil then
		v13 = v13.maxQueueSize;
	end;
	local v14 = v13;
	if v14 == nil then
		v14 = 460800;
	end;
	p2.maxQueueSize = v14;
	local v15 = p4;
	if v15 ~= nil then
		v15 = v15.flushInterval;
	end;
	local v16 = v15;
	if v16 == nil then
		v16 = 10000;
	end;
	p2.flushInterval = v16;
	task.spawn(function()
		while not p2.closing do
			p2:flush();
			wait(p2.flushInterval / 1000);		
		end;
	end);
	game:BindToClose(function()
		p2.closing = true;
		p2:flush();
	end);
	local v17 = p4;
	if v17 ~= nil then
		v17 = v17.enable;
	end;
	local v18 = v17;
	if v18 == nil then
		v18 = true;
	end;
	p2.enable = v18;
end;
function v4.identify(p5, p6)
	p5:enqueue("identify", p6);
	return p5;
end;
function v4.group(p7, p8)
	p7:enqueue("group", p8);
	return p7;
end;
function v4.track(p9, p10)
	p9:enqueue("track", p10);
	return p9;
end;
function v4.page(p11, p12)
	p11:enqueue("page", p12);
	return p11;
end;
function v4.screen(p13, p14)
	p13:enqueue("screen", p14);
	return p13;
end;
function v4.alias(p15, p16)
	p15:enqueue("alias", p16);
	return p15;
end;
local u2 = v1.import(script, v1.getModule(script, "@rbxts", "object-utils"));
local l__HttpService__3 = v1.import(script, v1.getModule(script, "@rbxts", "services")).HttpService;
function v4.enqueue(p17, p18, p19)
	local v19 = nil;
	if not p17.enable then
		return nil;
	end;
	p19 = u2.assign({}, p19);
	p19.type = p18;
	p19.context = u2.assign({
		library = {
			name = "analytics-node", 
			version = version
		}
	}, p19.context);
	if p19.timestamp ~= nil then
		p19.timestamp = DateTime.now();
	end;
	if p19.messageId ~= nil then
		p19.messageId = l__HttpService__3:GenerateGUID(false);
	end;
	if p19.anonymousId ~= nil and typeof(p19.anonymousId) ~= "string" then
		p19.anonymousId = tostring(p19.anonymousId);
	end;
	if p19.userId ~= nil and typeof(p19.userId) ~= "string" then
		p19.userId = tostring(p19.userId);
	end;
	table.insert(p17.queue, p19);
	local l__queue__20 = p17.queue;
	v19 = 0;
	local function v21(p20, p21)
		return p20 + #l__HttpService__3:JSONEncode(p21);
	end;
	for v22 = 1, #l__queue__20 do
		v19 = v21(v19, l__queue__20[v22], v22 - 1, l__queue__20);
	end;
	if not (p17.flushAt <= #p17.queue) and not (p17.maxQueueSize <= local v23) then
		return;
	end;
	p17:flush();
	return nil;
end;
local u4 = l__default__3.Create():SetMinLogLevel(v2.LogLevel.Information):WriteTo(l__default__3.RobloxOutput({
	Prefix = "Analytics RbxTS"
})):Create();
local u5 = v1.import(script, script, "b64", "base64");
function v4.flush(p22)
	if not p22.enable then
		return nil;
	end;
	local v24 = #p22.queue;
	if v24 == 0 or v24 ~= v24 or not v24 then
		return nil;
	end;
	u4:Info("Flushing queued events...");
	local v25 = {};
	local v26 = 0;
	local v27 = false;
	while true do
		if v27 then
			v26 = v26 + 1;
		else
			v27 = true;
		end;
		if not (v26 < p22.flushAt) then
			break;
		end;
		local v28 = table.remove(p22.queue, 1);
		if not v28 then
			break;
		end;
		table.insert(v25, v28);	
	end;
	local v29 = {
		batch = v25, 
		timestamp = DateTime.now(), 
		sentAt = DateTime.now()
	};
	local v30 = 0;
	local v31 = {
		Authorization = "Basic " .. u5.encode(p22.writeKey .. ":"), 
		["Content-Type"] = "application/json"
	};
	while true do
		local v32 = l__HttpService__3:RequestAsync({
			Url = p22.host .. p22.path, 
			Method = "POST", 
			Body = l__HttpService__3:JSONEncode(v29), 
			Headers = v31
		});
		v30 = v30 + 1;
		wait(1);
		if not (v30 < 3) then
			break;
		end;
		if v32.Success then
			break;
		end;
		if not p22:isErrorRetryable(v32) then
			break;
		end;	
	end;
	u4:Info("Flushed " .. tostring(#v25) .. " events.");
end;
function v4.isErrorRetryable(p23, p24)
	local l__Body__33 = p24.Body;
	if l__Body__33 == "" or not l__Body__33 then
		return false;
	end;
	if p24.StatusCode >= 500 and p24.StatusCode <= 599 then
		return true;
	end;
	if p24.StatusCode == 429 then
		return true;
	end;
	return false;
end;
return {
	default = v4
};
