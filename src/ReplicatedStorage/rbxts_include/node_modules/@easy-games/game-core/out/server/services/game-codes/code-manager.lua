-- Decompiled with the Synapse X Luau decompiler.

local v1 = _G[script];
local v2 = {};
local u1 = v1.import(script, v1.getModule(script, "@rbxts", "mockdatastoreservice").out);
function v2.constructor(p1, p2)
	p1.Name = "CodeManager";
	p1.Client = {};
	p1.gameCodes = {};
	p1.codeGenerators = {};
	p1.datastoreKey = "Codes";
	if p2 ~= "" and p2 then
		p1.datastoreKey = p2;
	end;
	p1.codesDataStore = u1:GetDataStore(p1.datastoreKey);
end;
local l__ColorUtil__2 = v1.import(script, script.Parent.Parent.Parent.Parent, "shared", "util", "color-util").ColorUtil;
local l__GameTheme__3 = v1.import(script, script.Parent.Parent.Parent.Parent, "shared", "ui", "game-theme").GameTheme;
function v2.redeemCode(p3, p4, p5)
	p5 = string.lower((string.gsub(p5, " ", "")));
	local v3 = p3:getCode(p5);
	if not v3 then
		return {
			success = false, 
			errorMessage = "<font color=\"" .. l__ColorUtil__2.richTextColor(l__GameTheme__3.backgroundError) .. "\"><b>\240\159\154\171 Error:</b></font> <font color=\"" .. l__ColorUtil__2.richTextColor(l__GameTheme__3.mcAqua) .. "\"><b>" .. p5 .. "</b></font> is not a valid code"
		};
	end;
	local function v4()
		local v5 = v3.codeRedeemLimits;
		if v5 ~= nil then
			v5 = v5.maxRedemptions;
		end;
		local v6 = v5;
		if v6 == nil then
			v6 = 1;
		end;
		if v6 <= v3.timesRedeemed then
			return {
				success = false, 
				errorMessage = "<font color=\"" .. l__ColorUtil__2.richTextColor(l__GameTheme__3.backgroundError) .. "\"><b>\240\159\154\171 Error:</b></font> This code has reached its max amount of redemptions"
			};
		end;
		if not v3.active then
			return {
				success = false, 
				errorMessage = "<font color=\"" .. l__ColorUtil__2.richTextColor(l__GameTheme__3.backgroundError) .. "\"><b>\240\159\154\171 Error:</b></font> This code is no longer active"
			};
		end;
		local v7 = v3.codeRedeemLimits;
		if v7 ~= nil then
			v7 = v7.expiresAt;
		end;
		if v7 ~= 0 and v7 == v7 and v7 and v3.codeRedeemLimits.expiresAt <= os.time() then
			return {
				success = false, 
				errorMessage = "<font color=\"" .. l__ColorUtil__2.richTextColor(l__GameTheme__3.backgroundError) .. "\"><b>\240\159\154\171 Error:</b></font> This code has expired and can no longer be redeemed"
			};
		end;
		return {
			success = true
		};
	end;
	local v8 = v4();
	if not v8.success then
		return {
			success = false, 
			errorMessage = v8.errorMessage
		};
	end;
	local v9 = p3:verifyCode(p4, v3);
	if not v9.success then
		return {
			success = false, 
			errorMessage = v9.errorMessage
		};
	end;
	local v10 = p3.codesDataStore;
	if v10 ~= nil then
		local v11 = {};
		local u4 = nil;
		v11[1] = v10:UpdateAsync(string.upper(p5), function(p6)
			if not p6 then
				return nil, nil, nil;
			end;
			local v12 = v4();
			u4 = v12;
			if not v12.success then
				return nil, nil, nil;
			end;
			p6.timesRedeemed = p6.timesRedeemed + 1;
			return p6;
		end);
		v10 = v11;
	end;
	if nil ~= nil and not (nil).success then
		return {
			success = false, 
			errorMessage = (nil).errorMessage
		};
	end;
	local l__codeGeneratorId__13 = v3.codeGeneratorId;
	if l__codeGeneratorId__13 ~= "" and l__codeGeneratorId__13 then
		local v14 = p3:getCodeGenerator(v3.codeGeneratorId);
		if v14 then
			v14:rewardPlayer(p4, v3);
		end;
	else
		p3:onRedeemGameCode(p4, v3);
	end;
	return {
		success = true, 
		data = {
			codeType = v3.type
		}
	};
end;
function v2.getCode(p7, p8)
	local l__gameCodes__15 = p7.gameCodes;
	local function v16(p9)
		return string.lower(p9.code) == string.lower(p8);
	end;
	local v17 = nil;
	for v18, v19 in ipairs(l__gameCodes__15) do
		if v16(v19, v18 - 1, l__gameCodes__15) == true then
			v17 = v19;
			break;
		end;
	end;
	if v17 then
		return v17;
	end;
	local v20 = p7.codesDataStore;
	if v20 ~= nil then
		v20 = v20:GetAsync(string.upper(p8));
	end;
	if v20 then
		return v20;
	end;
	return nil;
end;
function v2.addGameCode(p10, p11, p12, p13)
	table.insert(p10.gameCodes, {
		code = p11, 
		type = p12, 
		createdTime = os.time(), 
		timesRedeemed = 0, 
		active = true, 
		codeRedeemLimits = p13
	});
end;
function v2.addCodeGenerator(p14, p15)
	p14.codeGenerators[p15.id] = p15;
end;
function v2.getCodeGenerator(p16, p17)
	return p16.codeGenerators[p17];
end;
function v2.getCodeGenerators(p18)
	return p18.codeGenerators;
end;
function v2.addGeneratedCodes(p19, p20)
	local function v21(p21)
		local l__codesDataStore__22 = p19.codesDataStore;
		if l__codesDataStore__22 ~= nil then
			l__codesDataStore__22:SetAsync(p21.code, p21);
		end;
	end;
	for v23, v24 in ipairs(p20) do
		v21(v24, v23 - 1, p20);
	end;
end;
function v2.verifyCode(p22, p23, p24)
	if not p22:checkRedeemedCode(p23, p24) then
		return {
			success = true
		};
	end;
	return {
		success = false, 
		errorMessage = "<font color=\"" .. l__ColorUtil__2.richTextColor(l__GameTheme__3.backgroundError) .. "\"><b>\240\159\154\171 Error:</b></font> You've already redeemed this type of code"
	};
end;
local u5 = v1.import(script, v1.getModule(script, "@rbxts", "object-utils"));
function v2.getPlayerCodeGenInfo(p25, p26)
	local v25 = u5.entries((p25:getCodeGenerators()));
	local u6 = {};
	local function v26(p27)
		local v27 = p27[2];
		if not v27:hasPermission(p26.UserId) then
			return nil;
		end;
		u6[p27[1]] = {
			codes = v27:getGeneratedCodes(p26), 
			lastRegenTime = v27:getLastGenerateTime(p26)
		};
	end;
	for v28, v29 in ipairs(v25) do
		v26(v29, v28 - 1, v25);
	end;
	return u6;
end;
return {
	CodeManager = v2
};
