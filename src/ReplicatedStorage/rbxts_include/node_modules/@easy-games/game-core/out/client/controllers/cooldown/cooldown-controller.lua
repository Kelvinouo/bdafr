-- Script Hash: 61492c202032b084dde3a6e879b4a11d4b47bcc0673a9749f265894325650efa9fd64ec40c7f76719607a5685fe1e530
-- Decompiled with the Synapse X Luau decompiler.

local v1 = _G[script];
local v2 = v1.import(script, v1.getModule(script, "@flamework", "core").out);
local l__Reflect__3 = v2.Reflect;
local v4 = v1.import(script, v1.getModule(script, "@flamework", "core").out);
local v5 = setmetatable({}, {
	__tostring = function()
		return "CooldownController";
	end
});
v5.__index = v5;
function v5.new(...)
	local v6 = setmetatable({}, v5);
	return v6:constructor(...) and v6;
end;
function v5.constructor(p1)
	p1.cooldownMap = {};
	p1.barRegistry = {};
end;
function v5.onStart(p2)

end;
function v5.isOnCooldown(p3, p4)
	local v7 = p3.cooldownMap[p4];
	if v7 and os.clock() < v7.expire then
		return true;
	end;
	return false;
end;
local l__MapUtil__1 = v1.import(script, v1.getModule(script, "@easy-games", "data-structure").out).MapUtil;
local l__GameCoreClientSyncEvents__2 = v1.import(script, script.Parent.Parent.Parent, "game-core-client-events").GameCoreClientSyncEvents;
function v5.setOnCooldown(p5, p6, p7, p8)
	local v8 = l__MapUtil__1.getOrCreate(p5.cooldownMap, p6, {
		expire = os.clock() + p7, 
		bufferedCallbacks = {}, 
		cooldownConfig = p8 or {}, 
		startTime = os.clock(), 
		barMounted = false
	});
	v8.expire = math.max(os.clock() + p7, v8.expire);
	v8.cooldownConfig = p8 or v8.cooldownConfig;
	v8.startTime = os.clock();
	if p5.barRegistry[p6] ~= nil then
		p5.barRegistry[p6] = nil;
		v8.barMounted = true;
		p5.barRegistry[p6]().maid:GiveTask(function()
			v8.barMounted = false;
		end);
	end;
	if v8.terminatePromise then
		v8.terminatePromise:cancel();
	end;
	v8.terminatePromise = p5:getTerminatePromise(p6);
	l__GameCoreClientSyncEvents__2.CooldownStarted:fire(p6, os.clock(), p7);
end;
local u3 = v1.import(script, v1.getModule(script, "@rbxts", "maid").Maid);
local l__Flamework__4 = v2.Flamework;
local u5 = v1.import(script, v1.getModule(script, "@rbxts", "roact").src);
local l__CooldownBar__6 = v1.import(script, script.Parent, "ui", "cooldown-bar").CooldownBar;
local l__GameTheme__7 = v1.import(script, script.Parent.Parent.Parent.Parent, "shared", "ui", "game-theme").GameTheme;
function v5.createCooldownBar(p9, p10, p11)
	local v9 = nil;
	local u8 = u3.new();
	v9 = function()
		local v10 = u3.new();
		u8:GiveTask(v10);
		local u9 = l__Flamework__4.resolveDependency("@easy-games/game-core:client/controllers/action-bar/action-bar-controller@ActionBarController"):addComponent(u5.createFragment({
			[p10] = u5.createElement(l__CooldownBar__6, {
				cooldownId = p10, 
				Size = l__GameTheme__7.cooldownBarSize, 
				LayoutOrder = l__GameTheme__7.cooldownActionBarPriority
			})
		}));
		v10:GiveTask(function()
			if u9 then
				u9:DoCleaning();
			end;
		end);
		return {
			maid = v10
		};
	end;
	local v11 = p9.cooldownMap[p10];
	if not v11 then
		p9.barRegistry[p10] = v9;
		return u8;
	end;
	if v11.barMounted then
		return u8;
	end;
	local v12 = v9();
	v11.barMounted = true;
	u8:GiveTask(function()
		v11.barMounted = false;
	end);
	return u8;
end;
function v5.removeCooldown(p12, p13)
	local v13 = p12.cooldownMap[p13];
	if v13 then
		p12:runAllBufferedCallbacks(v13);
		if v13.terminatePromise then
			v13.terminatePromise:cancel();
		end;
		p12.cooldownMap[p13] = nil;
	end;
end;
function v5.getRemainingCooldown(p14, p15)
	local v14 = p14.cooldownMap[p15];
	if v14 ~= nil then
		v14 = v14.expire;
	end;
	local v15 = v14;
	if v15 == nil then
		v15 = 0;
	end;
	return math.max(0, v15 - os.clock());
end;
function v5.registerBufferedCallback(p16, p17, p18, p19)
	local v16 = p16.cooldownMap[p17];
	if not v16 or not p16:isOnCooldown(p17) then
		return false;
	end;
	v16.bufferedCallbacks[p18] = p19;
	if not v16.terminatePromise then
		v16.terminatePromise = p16:getTerminatePromise(p17);
	end;
	return true;
end;
function v5.getTerminatePromise(p20, p21)
	return v1.Promise.delay(p20:getRemainingCooldown(p21)):andThen(function()
		l__GameCoreClientSyncEvents__2.CooldownExpired:fire(p21);
		local v17 = p20.cooldownMap[p21];
		if not v17 then
			return nil;
		end;
		p20:runAllBufferedCallbacks(v17);
	end);
end;
function v5.runAllBufferedCallbacks(p22, p23)
	local l__bufferedCallbacks__18 = p23.bufferedCallbacks;
	local function v19(p24)
		v1.try(function()
			p24();
		end, function(p25)
			warn("Cooldown buffered callback errored:");
			warn(p25);
		end);
	end;
	for v20, v21 in pairs(l__bufferedCallbacks__18) do
		v19(v21, v20, l__bufferedCallbacks__18);
	end;
	p23.bufferedCallbacks = {};
end;
function v5.getCooldownData(p26, p27)
	return p26.cooldownMap[p27];
end;
l__Reflect__3.defineMetadata(v5, "identifier", "@easy-games/game-core:client/controllers/cooldown/cooldown-controller@CooldownController");
l__Reflect__3.defineMetadata(v5, "flamework:implements", { "$:flamework@OnStart" });
l__Reflect__3.decorate(v5, "$:flamework@Controller", v4.Controller, { {} });
l__Reflect__3.decorate(v5, "$:flamework@External", v4.External, {});
return {
	CooldownController = v5
};
