-- Decompiled with the Synapse X Luau decompiler.

local v1 = _G[script];
local l__Reflect__2 = v1.import(script, v1.getModule(script, "@flamework", "core").out).Reflect;
local v3 = v1.import(script, v1.getModule(script, "@flamework", "core").out);
local v4 = setmetatable({}, {
	__tostring = function()
		return "MatchmakingService";
	end
});
v4.__index = v4;
function v4.new(...)
	local v5 = setmetatable({}, v4);
	return v5:constructor(...) and v5;
end;
function v4.constructor(p1, p2, p3)
	p1.playFabService = p2;
	p1.deviceInfoService = p3;
	p1.matchFoundObservers = {};
	p1.partiesInQueue = {};
	function p1.partyProducer()
		return {};
	end;
end;
function v4.onStart(p4)
	p4:pollMatchmakingTickets();
end;
local l__PlayFabMultiplayer__1 = v1.import(script, v1.getModule(script, "@rbxts", "playfab").out).PlayFabMultiplayer;
v4.createMatchmakingTicketForParty = v1.async(function(p5, p6, p7)
	local v6 = p6:getLeader();
	local v7 = v1.await(p5.playFabService:getPlayerSession(v6));
	if not v7 then
		return nil;
	end;
	local v8 = p6:getMembers();
	local v9 = p5.playFabService:bulkGetPlayerSessions(v8);
	local v10 = {
		Creator = p5:createMatchmakingPlayer(v7, {
			skill = p6:getSkillRating(p7), 
			partyIsMobile = p6:isMobileOnly()
		}), 
		GiveUpAfterSeconds = 120, 
		QueueName = p7
	};
	local v11 = table.create(#v9);
	local v12, v13, v14 = ipairs(v9);
	while true do
		v12(v13, v14);
		if not v12 then
			break;
		end;
		v14 = v12;
		v11[v12] = v13.Entity;	
	end;
	v10.MembersToMatchWith = v11;
	local v15 = v1.await(l__PlayFabMultiplayer__1:CreateMatchmakingTicket(v7.EntityToken, v10));
	p5.partiesInQueue[p6] = os.clock();
	print("[Matchmaker] Created primary matchmaking ticket for party leader: " .. tostring(v6));
	local v16 = table.create(#v8);
	local v17, v18, v19 = ipairs(v8);
	while true do
		v17(v18, v19);
		if not v17 then
			break;
		end;
		local v20 = nil;
		local v21, v22, v23 = ipairs(v9);
		while true do
			v21(v22, v23);
			if not v21 then
				break;
			end;
			v23 = v21;
			if v22.Player == v18 == true then
				v20 = v22;
				break;
			end;		
		end;
		if v20 then
			v16[#v16 + 1] = l__PlayFabMultiplayer__1:JoinMatchmakingTicket(v20.EntityToken, {
				TicketId = v15.TicketId, 
				QueueName = p7, 
				Member = p5:createMatchmakingPlayer(v20, {
					skill = p6:getSkillRating(p7), 
					partyIsMobile = p6:isMobileOnly()
				})
			});
		end;	
	end;
	print("[Matchmaker] Added " .. tostring(#v16) .. " party members to the ticket");
	v1.await(v1.Promise.all(v16));
	return v15;
end);
v4.bulkCancelMatchmakingTickets = v1.async(function(p8, p9, p10)
	local v24, v25, v26 = ipairs(p9);
	while true do
		v24(v25, v26);
		if not v24 then
			break;
		end;
		v26 = v24;
		v1.try(function()
			v1.await(l__PlayFabMultiplayer__1:CancelAllMatchmakingTicketsForPlayer(v25.EntityToken, {
				QueueName = p10
			}));
		end, function(p11)
			warn("Failed to cancel all matchmaking tickets for player:", p11);
		end);	
	end;
end);
local l__QueueState__2 = v1.import(script, script.Parent.Parent.Parent, "shared", "party", "queue-state").QueueState;
local l__LobbyServerConfig__3 = v1.import(script, script.Parent.Parent, "config", "lobby-server-config").LobbyServerConfig;
local l__Workspace__4 = v1.import(script, v1.getModule(script, "@rbxts", "services")).Workspace;
v4.pollMatchmakingTickets = v1.async(function(p12)
	local v27 = p12.partyProducer();
	local u5 = 0;
	local function v28(p13)
		if p13:getQueueState() ~= l__QueueState__2.IN_QUEUE then
			p12.partiesInQueue[p13] = nil;
			return nil;
		end;
		u5 = u5 + 1;
		local v29 = p13:getQueueData();
		if not v29 then
			return nil;
		end;
		local l__pollAttempts__30 = v29.pollAttempts;
		if l__LobbyServerConfig__3.matchmakingPollMode == "aggresive" then
			if l__pollAttempts__30 < 3 then
				local v31 = 3;
			elseif l__pollAttempts__30 < 4 then
				v31 = 4;
			elseif l__pollAttempts__30 < 5 then
				v31 = 6;
			elseif l__pollAttempts__30 < 6 then
				v31 = 8;
			elseif l__pollAttempts__30 < 11 then
				v31 = 11;
			else
				v31 = 6;
			end;
		else
			v31 = 6;
		end;
		if v31 <= l__Workspace__4:GetServerTimeNow() - v29.lastPollTime then
			v29.pollAttempts = v29.pollAttempts + 1;
			v29.lastPollTime = l__Workspace__4:GetServerTimeNow();
			task.spawn(function()
				p12:pollQueueStatusForParty(p13);
			end);
		end;
	end;
	local v32, v33, v34 = ipairs(v27);
	while true do
		v32(v33, v34);
		if not v32 then
			break;
		end;
		v34 = v32;
		v28(v33, v32 - 1, v27);	
	end;
	task.delay(1, v1.async(function()
		v1.await(p12:pollMatchmakingTickets());
	end));
end);
v4.pollQueueStatusForParty = v1.async(function(p14, p15)
	local v35 = p15:getQueueData();
	if not v35 then
		return nil;
	end;
	local v36 = p15:getLeader();
	local v37 = v1.await(p14.playFabService:getPlayerSession(v36));
	if not v37 then
		return warn("Party leader " .. tostring(v36) .. " has no stored PlayFab session, unable to poll queue");
	end;
	local l__MatchId__38 = v1.await(l__PlayFabMultiplayer__1:GetMatchmakingTicket(v37.EntityToken, {
		TicketId = v35.ticketId, 
		QueueName = v35.queueType, 
		EscapeObject = true
	})).MatchId;
	if l__MatchId__38 == "" or not l__MatchId__38 then
		return nil;
	end;
	local v39 = v1.await(l__PlayFabMultiplayer__1:GetMatch(v37.EntityToken, {
		MatchId = l__MatchId__38, 
		QueueName = v35.queueType, 
		ReturnMemberAttributes = false, 
		EscapeObject = true
	}));
	local v40 = p14.partiesInQueue[p15];
	if v40 ~= 0 and v40 == v40 and v40 then
		print("Found match in " .. tostring(os.clock() - v40) .. " seconds");
	end;
	print("Found match for party leader " .. tostring(v36) .. ", ID: \"" .. l__MatchId__38 .. "\"");
	p14.partiesInQueue[p15] = nil;
	local v41, v42, v43 = ipairs(p14.matchFoundObservers);
	while true do
		v41(v42, v43);
		if not v41 then
			break;
		end;
		v43 = v41;
		local v44 = v42(p15, l__MatchId__38, v39);	
	end;
end);
local l__DeviceType__6 = v1.import(script, v1.getModule(script, "@easy-games", "game-core").out).DeviceType;
function v4.createMatchmakingPlayer(p16, p17, p18)
	local v45 = p16.deviceInfoService:getDeviceInfo(p17.Player.UserId);
	if not v45 then
		return {
			Entity = p17.Entity
		};
	end;
	local v46 = {
		Entity = p17.Entity
	};
	local v47 = {};
	local v48 = {
		Region = p16.deviceInfoService:getRegionCode(v45.region)
	};
	local v49 = p18.partyIsMobile;
	if v49 == nil then
		v49 = v45.device == l__DeviceType__6.Mobile;
	end;
	v48.IsMobile = tostring(v49);
	v48.Skill = p18.skill;
	v47.DataObject = v48;
	v46.Attributes = v47;
	return v46;
end;
function v4.registerMatchFoundObserver(p19, p20)
	local l__matchFoundObservers__50 = p19.matchFoundObservers;
	l__matchFoundObservers__50[#l__matchFoundObservers__50 + 1] = p20;
end;
function v4.registerPartyProducer(p21, p22)
	p21.partyProducer = p22;
end;
l__Reflect__2.defineMetadata(v4, "identifier", "@easy-games/lobby:server/services/matchmaking-service@MatchmakingService");
l__Reflect__2.defineMetadata(v4, "flamework:parameters", { "@easy-games/lobby:server/services/playfab-service@PlayFabService", "@easy-games/lobby:server/services/device-info-service@DeviceInfoService" });
l__Reflect__2.defineMetadata(v4, "flamework:implements", { "$:flamework@OnStart" });
l__Reflect__2.decorate(v4, "$:flamework@Service", v3.Service, {});
l__Reflect__2.decorate(v4, "$:flamework@External", v3.External, {});
return {
	MatchmakingService = v4
};
