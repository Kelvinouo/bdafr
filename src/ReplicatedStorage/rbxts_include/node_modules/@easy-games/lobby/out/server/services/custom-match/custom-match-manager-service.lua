-- Decompiled with the Synapse X Luau decompiler.

local v1 = _G[script];
local v2 = v1.import(script, v1.getModule(script, "@flamework", "core").out);
local l__Reflect__3 = v2.Reflect;
local v4 = v1.import(script, v1.getModule(script, "@rbxts", "services"));
local v5 = v1.import(script, script.Parent.Parent.Parent.Parent, "shared", "lobby-networking");
local v6 = setmetatable({}, {
	__tostring = function()
		return "CustomMatchManagerService";
	end
});
v6.__index = v6;
function v6.new(...)
	local v7 = setmetatable({}, v6);
	return v7:constructor(...) and v7;
end;
local u1 = v1.import(script, v1.getModule(script, "@rbxts", "mock-memory-store-service").lib);
function v6.constructor(p1)
	p1.customMatchStore = u1:GetSortedMap("lobby:CustomMatches");
end;
local l__Flamework__2 = v2.Flamework;
local l__LobbyNetEvents__3 = v5.LobbyNetEvents;
local l__LobbyNetFunctions__4 = v5.LobbyNetFunctions;
function v6.onStart(p2)
	local u5 = l__Flamework__2.resolveDependency("@easy-games/lobby:server/services/party-service@PartyService");
	l__LobbyNetEvents__3.server.createCustomMatch:connect(function(p3, p4, p5)
		local v8 = u5:getPartyForPlayer(p3);
		if not v8 then
			print("No party for player " .. tostring(p3) .. ", cannot create match");
			return false;
		end;
		local v9 = l__Flamework__2.resolveDependency("@easy-games/lobby:server/services/lobby-server-service@LobbyServerService"):getQueueMeta(p4);
		if not v9 then
			print("No queue meta found for custom match queue type: " .. p4);
			return false;
		end;
		if p5 ~= nil and table.find(v9.maps, p5) == nil then
			print("Selected queue type does not support the selected map: " .. p5);
			return false;
		end;
		local v10 = p2:generateNewMatch(v8, p4, p5);
		if not v10 then
			return false;
		end;
		p2:teleportToCustomMatch(v8, v10);
		return true;
	end);
	l__LobbyNetFunctions__4.server.joinCustomMatch:setCallback(function(p6, p7)
		local v11 = u5:getPartyForPlayer(p6);
		if v11 then
			return p2:joinCustomMatch(v11, p7);
		end;
		print("No party for player " .. tostring(p6) .. ", cannot join by code");
		return false;
	end);
end;
function v6.joinCustomMatch(p8, p9, p10)
	local v12 = p8:getMatchByJoinCode(string.upper(p10));
	if v12 then
		p8:teleportToCustomMatch(p9, v12);
		return true;
	end;
	print("No match for data for player " .. p9:getLeader().Name .. " when joining by code");
	return false;
end;
local l__TeleportService__6 = v4.TeleportService;
local u7 = v1.import(script, v1.getModule(script, "@rbxts", "inspect").inspect);
function v6.generateNewMatch(p11, p12, p13, p14)
	local v13 = v1.Promise.retry(v1.async(function()
		local v14 = p11:generateJoinCode(p12:getLeader());
		if p11:getMatchByJoinCode(v14) then
			error("Match already exists");
		end;
		return v14;
	end), 3):expect();
	if v13 == "" or not v13 then
		error("Could not get join code");
	end;
	local u8 = {
		hostUserId = p12:getLeader().UserId, 
		queueType = p13, 
		joinCode = v13, 
		selectedMap = p14, 
		accessCode = l__TeleportService__6:ReserveServer(l__Flamework__2.resolveDependency("@easy-games/lobby:server/services/lobby-server-service@LobbyServerService"):getQueueMeta(p13).placeId)
	};
	v1.Promise.retry(v1.async(function()
		return p11.customMatchStore:SetAsync(v13, u8, 3600);
	end), 3);
	print("Generated new custom match with config: " .. u7(u8));
	return u8;
end;
function v6.getMatchByJoinCode(p15, p16)
	local v15 = {};
	v15[1] = v1.Promise.retry(v1.async(function()
		return p15.customMatchStore:GetAsync(p16);
	end), 3):await();
	if not v15[1] then
		return nil;
	end;
	return v15[2];
end;
function v6.teleportToCustomMatch(p17, p18, p19)
	local v16 = Instance.new("TeleportOptions");
	v16.ReservedServerAccessCode = p19.accessCode;
	l__Flamework__2.resolveDependency("@easy-games/lobby:server/services/game-teleport-service@GameTeleportService"):teleportPartyToPlace(l__Flamework__2.resolveDependency("@easy-games/lobby:server/services/lobby-server-service@LobbyServerService"):getQueueMeta(p19.queueType).placeId, p18, {
		teleportData = p17:getTeleportData(p19), 
		teleportOptions = v16
	});
	print("Teleported party to custom match with teleport data: " .. u7(v16:GetTeleportData()));
end;
function v6.getTeleportData(p20, p21)
	if p21.selectedMap == nil then
		p21.selectedMap = "";
	end;
	return {
		customMatch = p21, 
		customMatchHash = p20:generateMatchConfigHash(p21)
	};
end;
local l__HttpService__9 = v4.HttpService;
function v6.generateMatchConfigHash(p22, p23)
	local v17 = l__HttpService__9:JSONEncode(p23);
	return "todo";
end;
function v6.generateJoinCode(p24, p25)
	local v18 = "";
	local v19 = 0;
	local v20 = false;
	while true do
		if v20 then
			v19 = v19 + 1;
		else
			v20 = true;
		end;
		if not (v19 < 4) then
			break;
		end;
		local v21 = math.ceil(math.random() * 34);
		v18 = v18 .. string.sub("ABCDEFGHIJKLMNPQRSTUVWXYZ123456789", v21, v21);	
	end;
	return v18;
end;
function v6.deleteCustomMatch(p26, p27)
	p26.customMatchStore:RemoveAsync(p27);
end;
l__Reflect__3.defineMetadata(v6, "identifier", "@easy-games/lobby:server/services/custom-match/custom-match-manager-service@CustomMatchManagerService");
l__Reflect__3.defineMetadata(v6, "flamework:isExternal", true);
l__Reflect__3.defineMetadata(v6, "flamework:implements", { "$:flamework@OnStart" });
l__Reflect__3.defineMetadata(v6, "flamework:decorators", { "$:flamework@Service" });
l__Reflect__3.defineMetadata(v6, "flamework:decorators.$:flamework@Service", {
	type = "Service"
});
return {
	CustomMatchManagerService = v6
};
